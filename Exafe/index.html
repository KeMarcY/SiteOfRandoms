<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Exafe | Universal Image Tool</title>

    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- Metadata Reader (Supports HEIC, PNG, JPG, TIFF, AVIF) -->
    <script src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.js"></script>
    <!-- HEIC Converter -->
    <script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.4/dist/heic2any.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #e2e8f0;
            --text: #0f172a;
            --text-secondary: #64748b;
            --card-bg: #ffffff;
            --border: #cbd5e1;
            --shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            --code-bg: #f8fafc;
            --danger: #ef4444;
            --scrollbar-track: #f1f5f9;
            --scrollbar-thumb: #cbd5e1;
            --drag-overlay: rgba(37, 99, 235, 0.1);
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --bg: #0f172a;
                --text: #f1f5f9;
                --text-secondary: #94a3b8;
                --card-bg: #1e293b;
                --border: #334155;
                --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
                --code-bg: #020617;
                --scrollbar-track: #0f172a;
                --scrollbar-thumb: #334155;
                --drag-overlay: rgba(37, 99, 235, 0.2);
            }
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            padding: 30px 20px;
            box-sizing: border-box;
        }

        .container {
            margin: auto;
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            box-shadow: var(--shadow);
            width: 100%;
            max-width: 600px;
            border: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            gap: 15px;
            position: relative;
        }

        header {
            text-align: center;
            margin-bottom: 5px;
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            letter-spacing: -1px;
        }

        p {
            color: var(--text-secondary);
            margin-top: 5px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        #fileInput {
            display: none;
        }

        .upload-box {
            border: 2px dashed var(--border);
            border-radius: 12px;
            padding: 3rem 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background-color: rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .upload-box:hover {
            border-color: var(--primary);
            background-color: rgba(37, 99, 235, 0.05);
        }

        .upload-box.drag-active,
        .add-card.drag-active {
            border-color: var(--primary);
            background-color: var(--drag-overlay);
            transform: scale(1.02);
        }

        .gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
        }

        .thumb-card {
            position: relative;
            aspect-ratio: 1;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid transparent;
            cursor: grab;
            transition: transform 0.2s, border-color 0.2s;
            background: var(--code-bg);
        }

        .thumb-card:active {
            cursor: grabbing;
        }

        .thumb-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.3);
            z-index: 2;
        }

        .thumb-card img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .fmt-badge {
            position: absolute;
            bottom: 2px;
            left: 2px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            font-size: 9px;
            padding: 1px 3px;
            border-radius: 3px;
            font-weight: bold;
            pointer-events: none;
            text-transform: uppercase;
        }

        .remove-btn {
            position: absolute;
            top: 2px;
            right: 2px;
            background: rgba(0, 0, 0, 0.6);
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 10px;
            line-height: 18px;
            cursor: pointer;
            z-index: 3;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: var(--danger);
        }

        .add-card {
            aspect-ratio: 1;
            border: 2px dashed var(--border);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.5rem;
            transition: all 0.2s;
            background: rgba(0, 0, 0, 0.01);
        }

        .add-card:hover {
            border-color: var(--primary);
            background: rgba(37, 99, 235, 0.05);
        }

        .meta-panel {
            background: var(--code-bg);
            border-radius: 10px;
            border: 1px solid var(--border);
            display: none;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
            box-sizing: border-box;
            margin-top: 5px;
        }

        .meta-header {
            padding: 10px 15px;
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text);
            border-bottom: 1px solid var(--border);
            background: rgba(0, 0, 0, 0.02);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meta-content {
            padding: 15px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, monospace;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            gap: 5px;
            height: 220px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: var(--scrollbar-thumb) var(--code-bg);
        }

        .meta-content::-webkit-scrollbar {
            width: 10px;
        }

        .meta-content::-webkit-scrollbar-track {
            background: transparent;
            margin: 4px 0;
        }

        .meta-content::-webkit-scrollbar-thumb {
            background-color: var(--scrollbar-thumb);
            border-radius: 20px;
            border: 3px solid var(--code-bg);
        }

        .meta-row {
            display: flex;
            justify-content: space-between;
            word-break: break-all;
            line-height: 1.4;
        }

        .key {
            color: var(--text-secondary);
            margin-right: 15px;
            min-width: 100px;
        }

        .val {
            color: var(--primary);
            text-align: right;
        }

        .val.danger {
            color: var(--danger);
            font-weight: 600;
        }

        .action-area {
            display: none;
            flex-direction: column;
            gap: 10px;
            width: 100%;
        }

        button.primary-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            width: 100%;
            transition: background 0.2s, transform 0.1s;
        }

        button.primary-btn:hover {
            background-color: var(--primary-hover);
        }

        button.primary-btn:active {
            transform: scale(0.99);
        }

        button.primary-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #status {
            font-size: 0.85rem;
            text-align: center;
            min-height: 1.2em;
            font-weight: 500;
        }

        .success {
            color: #22c55e;
        }

        .processing {
            color: var(--primary);
        }
    </style>
</head>

<body>

    <div class="container">
        <header>
            <h1>Exafe</h1>
            <p>Metadata Viewer and Cleaner (HEIC, JPG, PNG, GIF, WEBP)</p>
        </header>

        <input type="file" id="fileInput" multiple
            accept="image/png, image/jpeg, image/webp, image/heic, image/gif, image/bmp, image/avif, .heic, .heif">

        <div id="initialUploadBox" class="upload-box" onclick="triggerUpload()">
            <span style="font-size: 2rem; margin-bottom: 10px;">➕</span>
            <span style="font-weight: 500;">Click or Drag Images</span>
        </div>

        <div id="gallery" class="gallery"></div>

        <div class="meta-panel" id="metaPanel">
            <div class="meta-header">
                <span id="metaTitle">Metadata Viewer</span>
            </div>
            <div class="meta-content" id="metaList">
                <div
                    style="color: var(--text-secondary); display: flex; align-items: center; justify-content: center; height: 100%;">
                    No image selected
                </div>
            </div>
        </div>

        <div class="action-area" id="actionArea">
            <div id="status"></div>
            <button id="downloadBtn" class="primary-btn" disabled>Download Cleaned Image(s)</button>
        </div>
    </div>

    <script>
        // State Management
        let filesData = [];
        let selectedId = null;

        // Elements
        const fileInput = document.getElementById('fileInput');
        const initialUploadBox = document.getElementById('initialUploadBox');
        const gallery = document.getElementById('gallery');
        const metaList = document.getElementById('metaList');
        const metaTitle = document.getElementById('metaTitle');
        const metaPanel = document.getElementById('metaPanel');
        const actionArea = document.getElementById('actionArea');
        const downloadBtn = document.getElementById('downloadBtn');
        const statusDiv = document.getElementById('status');

        const DANGEROUS_KEYS = ['gps', 'latitude', 'longitude', 'altitude', 'serial', 'cameraowner', 'lensid', 'location'];

        const miniAddCard = document.createElement('div');
        miniAddCard.className = 'add-card static';
        miniAddCard.innerHTML = '➕';
        miniAddCard.onclick = triggerUpload;

        Sortable.create(gallery, {
            animation: 150,
            filter: '.static',
            onMove: (evt) => evt.related.className.indexOf('static') === -1
        });

        // --- Event Listeners ---
        fileInput.addEventListener('change', (e) => processFiles(e.target.files));
        downloadBtn.addEventListener('click', handleDownload);
        setupDragDrop(initialUploadBox);
        setupDragDrop(miniAddCard);

        function setupDragDrop(element) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eName => {
                element.addEventListener(eName, (e) => { e.preventDefault(); e.stopPropagation(); });
            });
            ['dragenter', 'dragover'].forEach(eName => element.addEventListener(eName, () => element.classList.add('drag-active')));
            ['dragleave', 'drop'].forEach(eName => element.addEventListener(eName, () => element.classList.remove('drag-active')));
            element.addEventListener('drop', (e) => processFiles(e.dataTransfer.files));
        }

        function triggerUpload() { fileInput.click(); }

        async function processFiles(files) {
            const newFiles = Array.from(files);
            if (newFiles.length === 0) return;

            const hasHeic = newFiles.some(f => f.name.toLowerCase().endsWith('.heic'));
            if (hasHeic) statusDiv.innerText = "Converting HEIC files...";

            let lastId = null;

            for (const file of newFiles) {
                // Expanded file type check
                const name = file.name.toLowerCase();
                const isHeic = name.endsWith('.heic') || file.type === 'image/heic';
                const isImage = file.type.startsWith('image/') || /\.(jpg|jpeg|png|webp|gif|bmp|avif|heif)$/.test(name);

                if (!isImage && !isHeic) continue;

                const id = Math.random().toString(36).substr(2, 9);
                let displayUrl = '';
                let displayFile = file;

                try {
                    if (isHeic) {
                        const convertedBlob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.8 });
                        displayFile = convertedBlob;
                        displayUrl = URL.createObjectURL(convertedBlob);
                    } else {
                        displayUrl = URL.createObjectURL(file);
                    }

                    filesData.push({ id, originalFile: file, displayFile: displayFile, url: displayUrl, isHeic });

                    let label = null;
                    if (isHeic) label = 'HEIC';
                    else if (name.endsWith('.gif')) label = 'GIF';
                    else if (name.endsWith('.webp')) label = 'WEBP';
                    else if (name.endsWith('.bmp')) label = 'BMP';
                    else if (name.endsWith('.avif')) label = 'AVIF';

                    addThumbnailToDOM(id, displayUrl, label);
                    lastId = id;

                } catch (e) {
                    console.error("Error processing file:", file.name, e);
                }
            }

            fileInput.value = '';
            statusDiv.innerText = "";
            if (lastId) selectImage(lastId);
            updateInterface();
        }

        function addThumbnailToDOM(id, url, label) {
            const div = document.createElement('div');
            div.className = 'thumb-card';
            div.dataset.id = id;
            div.onclick = (e) => {
                if (!e.target.closest('.remove-btn')) selectImage(id);
            };

            const img = document.createElement('img');
            img.src = url;
            div.appendChild(img);

            if (label) {
                const badge = document.createElement('div');
                badge.className = 'fmt-badge';
                badge.innerText = label;
                div.appendChild(badge);
            }

            const rmBtn = document.createElement('button');
            rmBtn.className = 'remove-btn';
            rmBtn.innerHTML = '×';
            rmBtn.onclick = (e) => {
                e.stopPropagation();
                removeImage(id);
            };
            div.appendChild(rmBtn);

            if (gallery.contains(miniAddCard)) gallery.insertBefore(div, miniAddCard);
            else gallery.appendChild(div);
        }

        function removeImage(id) {
            const el = document.querySelector(`.thumb-card[data-id="${id}"]`);
            if (el) el.remove();

            const fileObj = filesData.find(f => f.id === id);
            if (fileObj) URL.revokeObjectURL(fileObj.url);

            filesData = filesData.filter(f => f.id !== id);

            if (selectedId === id) {
                metaList.innerHTML = '<div style="color: var(--text-secondary); display: flex; align-items: center; justify-content: center; height: 100%;">Image removed.</div>';
                metaTitle.innerText = 'Metadata Viewer';
                selectedId = null;
            }
            if (filesData.length === 0) statusDiv.textContent = '';
            updateInterface();
        }

        async function selectImage(id) {
            selectedId = id;
            document.querySelectorAll('.thumb-card').forEach(el => el.classList.remove('selected'));
            const el = document.querySelector(`.thumb-card[data-id="${id}"]`);
            if (el) el.classList.add('selected');

            const item = filesData.find(f => f.id === id);
            if (!item) return;

            metaTitle.innerText = item.originalFile.name;
            metaList.innerHTML = '<div style="padding: 10px; color: var(--primary);">Reading...</div>';

            try {
                const output = await exifr.parse(item.originalFile, {
                    tiff: true,
                    exif: true,
                    gps: true,
                });

                metaList.innerHTML = '';
                addMetaRow('File Type', item.isHeic ? 'HEIC (Apple)' : item.originalFile.name.split('.').pop().toUpperCase());
                addMetaRow('Size', (item.originalFile.size / 1024 / 1024).toFixed(2) + ' MB');

                if (output) {
                    for (let [key, val] of Object.entries(output)) {
                        if (val instanceof Uint8Array || (typeof val === 'object' && val !== null && !val.toString().match(/Date|Array/))) continue;
                        if (val instanceof Date) val = val.toLocaleString();
                        addMetaRow(key, val);
                    }
                } else {
                    const div = document.createElement('div');
                    div.style.padding = "10px";
                    div.style.textAlign = "center";
                    div.style.color = "var(--text-secondary)";
                    div.textContent = "No hidden metadata found (Image is likely clean).";
                    metaList.appendChild(div);
                }
            } catch (err) {
                console.error(err);
                metaList.innerHTML = '<div style="padding:10px; color:var(--danger)">Error reading metadata.</div>';
            }
        }

        function addMetaRow(key, val) {
            const row = document.createElement('div');
            row.className = 'meta-row';
            const isDangerous = DANGEROUS_KEYS.some(danger => key.toLowerCase().includes(danger));
            const valClass = isDangerous ? 'val danger' : 'val';

            let displayVal = String(val);
            if (displayVal.length > 50) displayVal = displayVal.substring(0, 50) + '...';

            row.innerHTML = `<span class="key">${key}</span><span class="${valClass}">${displayVal}</span>`;
            metaList.appendChild(row);
        }

        function updateInterface() {
            const hasFiles = filesData.length > 0;
            initialUploadBox.style.display = hasFiles ? 'none' : 'flex';
            if (hasFiles && !gallery.contains(miniAddCard)) gallery.appendChild(miniAddCard);
            else if (!hasFiles) miniAddCard.remove();

            const displayStyle = hasFiles ? 'flex' : 'none';
            metaPanel.style.display = displayStyle;
            actionArea.style.display = displayStyle;

            downloadBtn.disabled = !hasFiles;
            downloadBtn.textContent = hasFiles ? `Download Cleaned Images (${filesData.length})` : 'Download Cleaned Image';
        }

        async function handleDownload() {
            if (filesData.length === 0) return;

            downloadBtn.disabled = true;
            statusDiv.className = 'processing';
            statusDiv.innerText = "Cleaning images...";

            const d = new Date();
            const dateStr = d.toISOString().split('T')[0].replace(/-/g, '');

            // 1. Generate one random code for the entire batch (or single file)
            const batchRandomCode = Math.random().toString(36).substr(2, 6);

            // Single File Download
            if (filesData.length === 1) {
                const item = filesData[0];
                const ext = item.isHeic ? 'jpg' : (item.originalFile.name.split('.').pop() || 'jpg');
                // Naming pattern: exafe_DATE_CODE.ext (no number for single file)
                const newName = `exafe_${dateStr}_${batchRandomCode}.${ext}`;

                const cleanedBlob = await cleanImageToBlob(item);
                const url = URL.createObjectURL(cleanedBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = newName;
                link.click();

                statusDiv.className = 'success';
                statusDiv.innerText = "Download Started!";
                downloadBtn.disabled = false;
                return;
            }

            // Batch Download (Zip)
            const zip = new JSZip();

            // Get current DOM order to respect sorting
            const domElements = Array.from(gallery.children).filter(el => el.classList.contains('thumb-card'));

            for (let i = 0; i < domElements.length; i++) {
                const id = domElements[i].dataset.id;
                const item = filesData.find(f => f.id === id);
                if (!item) continue;

                statusDiv.innerText = `Cleaning ${i + 1}/${domElements.length}...`;

                const ext = item.isHeic ? 'jpg' : (item.originalFile.name.split('.').pop() || 'jpg');

                // Naming pattern: exafe_DATE_CODE_NUMBER.ext
                // CODE is shared, NUMBER is sequential based on sort order
                const newName = `exafe_${dateStr}_${batchRandomCode}_${i + 1}.${ext}`;

                const cleanedBlob = await cleanImageToBlob(item);
                zip.file(newName, cleanedBlob);
            }

            statusDiv.innerText = "Zipping...";
            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(content);
            link.download = `exafe_batch_${dateStr}.zip`;
            link.click();

            statusDiv.className = 'success';
            statusDiv.innerText = "Done!";
            downloadBtn.disabled = false;
        }

        function cleanImageToBlob(item) {
            return new Promise((resolve) => {
                const fileToDraw = item.displayFile;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        canvas.width = img.width;
                        canvas.height = img.height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0);
                        canvas.toBlob(blob => resolve(blob), 'image/jpeg', 0.92);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(fileToDraw);
            });
        }
    </script>
</body>

</html>